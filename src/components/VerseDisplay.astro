---
import SanskritText from './SanskritText.astro';
import Bhashya from './Bhashya.astro';
import ConceptTag from './ConceptTag.astro';
import RelatedVerses from './RelatedVerses.astro';

interface VerseData {
  id: string;
  text: string;
  chapter?: number;
  verse: number;
  reference: string;
  original: {
    devanagari: string;
    iast: string;
  };
  wordAnalysis: Array<{
    word: string;
    transliteration: string;
    meaning: string;
    grammar: string;
    root?: string;
  }>;
  translations: Array<{
    translator: string;
    text: string;
    style?: string;
  }>;
  bhashya: {
    sanskrit: string;
    iast: string;
    translation: string;
    notes?: string;
  };
  centralTeaching: string;
  coreConcepts: Array<{
    term: string;
    transliteration: string;
    definition: string;
    importance: 'primary' | 'secondary';
  }>;
  relatedVerses: Array<{
    verseId: string;
    reference: string;
    text?: string;
    relationship: 'parallel' | 'elaboration' | 'contrast' | 'prerequisite';
    note: string;
  }>;
}

interface Props {
  verse: VerseData;
  prevVerseId?: string;
  nextVerseId?: string;
}

const { verse, prevVerseId, nextVerseId } = Astro.props;
---

<article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Breadcrumb -->
  <nav class="text-sm text-text-muted mb-6">
    <a href="/library" class="hover:text-accent-saffron">Library</a>
    <span class="mx-2">›</span>
    <a href={`/library/${verse.text}`} class="hover:text-accent-saffron">{verse.text}</a>
    <span class="mx-2">›</span>
    <span class="text-text-primary">{verse.reference}</span>
  </nav>

  <!-- Section 1: Original Verse -->
  <header class="mb-8">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-semibold text-accent-saffron text-center flex-1">
        {verse.reference}
      </h1>
      <!-- Mobile verse sidebar toggle -->
      <button id="verse-sidebar-btn" class="lg:hidden p-2 ml-4 text-text-primary hover:text-accent-saffron" aria-label="Open verse sidebar">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    <SanskritText 
      devanagari={verse.original.devanagari} 
      size="large" 
      center={true}
      words={verse.wordAnalysis}
      interactive={true}
    />
  </header>

  <div class="space-y-6">
    <!-- Section 2: IAST Transliteration -->
    <details class="bg-bg-white rounded-lg border border-border overflow-hidden">
      <summary class="cursor-pointer px-6 py-4 font-semibold text-text-primary hover:bg-bg-sanskrit transition-colors flex justify-between items-center">
        <span>IAST Transliteration</span>
        <span class="text-accent-saffron">⊕</span>
      </summary>
      <div class="px-6 py-4 border-t border-border">
        <p class="font-mono text-text-primary leading-relaxed">
          {verse.original.iast}
        </p>
      </div>
    </details>

    <!-- Section 3: Translation -->
    <section class="bg-bg-white rounded-lg border border-border p-6">
      <h3 class="text-lg font-semibold text-text-primary mb-4">
        अनुवाद (Translation)
      </h3>
      {verse.translations.map(translation => (
        <div class="mb-4 last:mb-0">
          <p class="text-text-primary leading-relaxed mb-2">
            "{translation.text}"
          </p>
          <p class="text-sm text-text-muted italic">
            — {translation.translator}
          </p>
        </div>
      ))}
    </section>

    <!-- Section 4: Śaṅkara Bhagavadpāda's Commentary (MOST IMPORTANT) -->
    <Bhashya content={verse.bhashya} />

    <!-- Section 5: Central Teaching -->
    <section class="bg-linear-to-br from-bg-sanskrit to-bg-white rounded-lg border-l-4 border-accent-saffron p-6">
      <h3 class="text-lg font-semibold text-accent-saffron mb-3">
        मुख्य बोध (Central Teaching)
      </h3>
      <p class="text-text-primary leading-relaxed text-lg">
        {verse.centralTeaching}
      </p>
    </section>

    <!-- Section 6: Core Concepts -->
    <ConceptTag concepts={verse.coreConcepts} />

    <!-- Section 7: Related Verses -->
    <RelatedVerses verses={verse.relatedVerses} />
  </div>

  <!-- Navigation -->
  <nav class="flex justify-between items-center mt-12 pt-8 border-t border-border">
    <div>
      {prevVerseId ? (
        <a 
          href={`/verse/${prevVerseId}`}
          class="flex items-center gap-2 text-accent-saffron hover:text-accent-sandalwood transition-colors"
        >
          <span>←</span>
          <span>Previous</span>
        </a>
      ) : (
        <span class="text-text-muted">← Previous</span>
      )}
    </div>
    
    <a 
      href="/library" 
      class="text-text-secondary hover:text-accent-saffron transition-colors"
    >
      Back to Library
    </a>
    
    <div>
      {nextVerseId ? (
        <a 
          href={`/verse/${nextVerseId}`}
          class="flex items-center gap-2 text-accent-saffron hover:text-accent-sandalwood transition-colors"
        >
          <span>Next</span>
          <span>→</span>
        </a>
      ) : (
        <span class="text-text-muted">Next →</span>
      )}
    </div>
  </nav>
</article>

<!-- Mobile Quick Jump Navigation (Top Sticky) -->
<div class="lg:hidden sticky top-14 z-40 bg-bg-white/95 backdrop-blur-sm border-b border-border">
  <div class="max-w-4xl mx-auto px-4 py-2 flex items-center gap-2">
    <a href={prevVerseId ? `/verse/${prevVerseId}` : undefined} class={`px-3 py-2 rounded border ${prevVerseId ? 'border-border text-text-primary hover:bg-bg-sanskrit' : 'border-border text-text-muted cursor-not-allowed'}`} aria-disabled={!prevVerseId}>Prev</a>
    <div class="flex-1 overflow-x-auto">
      <div class="flex items-center gap-1 min-w-max">
        {Array.from({ length: 18 }, (_, i) => {
          const id = `isha-${String(i + 1).padStart(2, '0')}`;
          return (
            <a href={`/verse/${id}`} class="px-2 py-1 rounded-full text-xs border border-border bg-bg-white hover:bg-bg-sanskrit hover:text-accent-saffron">
              {i + 1}
            </a>
          );
        })}
      </div>
    </div>
    <a href={nextVerseId ? `/verse/${nextVerseId}` : undefined} class={`px-3 py-2 rounded border ${nextVerseId ? 'border-border text-text-primary hover:bg-bg-sanskrit' : 'border-border text-text-muted cursor-not-allowed'}`} aria-disabled={!nextVerseId}>Next</a>
  </div>
</div>

<!-- Mobile Verse Sidebar & Overlay -->
<div id="verse-overlay" class="fixed inset-0 bg-black/40 hidden z-40"></div>
<aside id="verse-sidebar" class="fixed top-0 left-0 h-full w-64 bg-bg-white border-r border-border shadow-xl -translate-x-full transition-transform z-50">
  <div class="px-4 py-3 border-b border-border flex items-center justify-between">
    <span class="font-semibold text-text-primary">Quick Jump</span>
    <button id="verse-sidebar-close" class="p-2 text-text-muted hover:text-text-primary" aria-label="Close">
      ✕
    </button>
  </div>
  <nav class="p-4 space-y-3">
    <div class="grid grid-cols-6 gap-2">
      {Array.from({ length: 18 }, (_, i) => {
        const id = `isha-${String(i + 1).padStart(2, '0')}`;
        return (
          <a href={`/verse/${id}`} class="px-2 py-1 rounded border border-border text-sm text-text-primary hover:bg-bg-sanskrit hover:text-accent-saffron text-center">
            {i + 1}
          </a>
        );
      })}
    </div>
    <a href="/library/isha-upanishad" class="block mt-4 text-sm text-text-secondary hover:text-accent-saffron">Back to Īśa Upaniṣad</a>
    <a href="/library" class="block text-sm text-text-secondary hover:text-accent-saffron">All Texts</a>
  </nav>
  <div class="absolute bottom-4 left-0 w-full px-4">
    <a href="/guidance" class="block text-xs text-text-muted hover:text-accent-saffron">Study under guru guidance</a>
  </div>
  </aside>

<script>
  const btn = document.getElementById('verse-sidebar-btn');
  const sidebar = document.getElementById('verse-sidebar');
  const overlay = document.getElementById('verse-overlay');
  const closeBtn = document.getElementById('verse-sidebar-close');

  function openSidebar() {
    sidebar?.classList.remove('-translate-x-full');
    overlay?.classList.remove('hidden');
  }
  function closeSidebar() {
    sidebar?.classList.add('-translate-x-full');
    overlay?.classList.add('hidden');
  }

  btn?.addEventListener('click', openSidebar);
  closeBtn?.addEventListener('click', closeSidebar);
  overlay?.addEventListener('click', closeSidebar);
</script>

<style>
  details[open] summary span:last-child::before {
    content: '⊖';
  }
  details[open] summary span:last-child {
    display: none;
  }
  details[open] summary::after {
    content: '⊖';
    color: var(--color-accent-saffron);
  }
</style>
