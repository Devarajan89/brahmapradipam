---
interface RelatedVerse {
  verseId: string;
  reference: string;
  text?: string;
  relationship: 'parallel' | 'elaboration' | 'contrast' | 'prerequisite';
  note: string;
}

interface Props {
  verses: RelatedVerse[];
}

const { verses } = Astro.props;

// Helper to extract source text name from reference
const extractSource = (ref: string): string => {
  if (ref.includes('Upanishad') || ref.includes('Upaniá¹£ad')) {
    return ref.split(' ').slice(0, 2).join(' ');
  }
  if (ref.includes('Gita') || ref.includes('GÄ«tÄ')) {
    return 'Bhagavad Gita';
  }
  if (ref.includes('Sutra') || ref.includes('SÅ«tra')) {
    return 'Brahma Sutras';
  }
  return ref.split(' ')[0];
};

// Helper to extract chapter/verse info
const extractVerseNum = (ref: string): string => {
  const parts = ref.split(' ');
  return parts[parts.length - 1] || '';
};

const relationshipInfo = {
  parallel: {
    label: 'Parallel Teaching',
    icon: 'â‡„',
    description: 'Presents the same truth from a different angle',
    color: 'text-blue-600',
    bg: 'bg-blue-50',
    border: 'border-blue-200'
  },
  elaboration: {
    label: 'Elaboration',
    icon: 'â†—',
    description: 'Expands on the concept taught here',
    color: 'text-accent-saffron',
    bg: 'bg-bg-sanskrit',
    border: 'border-accent-saffron'
  },
  contrast: {
    label: 'Contrasting View',
    icon: 'â‡”',
    description: 'Shows what this teaching opposes or transcends',
    color: 'text-purple-600',
    bg: 'bg-purple-50',
    border: 'border-purple-200'
  },
  prerequisite: {
    label: 'Foundation',
    icon: 'â†‘',
    description: 'Foundational teaching to understand this verse',
    color: 'text-green-600',
    bg: 'bg-green-50',
    border: 'border-green-200'
  }
};

// Group verses by relationship
const groupedVerses = verses.reduce((acc, verse) => {
  if (!acc[verse.relationship]) {
    acc[verse.relationship] = [];
  }
  acc[verse.relationship].push(verse);
  return acc;
}, {} as Record<string, RelatedVerse[]>);
---

{verses && verses.length > 0 && (
  <section class="bg-linear-to-br from-bg-white to-bg-sanskrit border border-border rounded-lg p-6">
    <div class="flex items-center gap-3 mb-6">
      <h4 class="text-xl font-semibold text-text-primary">
        Related Verses
      </h4>
      <span class="text-sm text-text-muted">
        â€¢ {verses.length} connection{verses.length !== 1 ? 's' : ''}
      </span>
    </div>
    
    <div class="space-y-6">
      {Object.entries(groupedVerses).map(([relationship, relVerses]) => {
        const info = relationshipInfo[relationship as keyof typeof relationshipInfo];
        if (!info) return null;
        return (
          <div class="space-y-3">
            {/* Relationship Type Header */}
            <div class={`flex items-center gap-2 pb-2 border-b-2 ${info.border}`}>
              <span class={`text-xl ${info.color}`}>{info.icon}</span>
              <div class="flex-1">
                <h5 class={`font-semibold ${info.color}`}>
                  {info.label}
                </h5>
                <p class="text-xs text-text-muted italic">
                  {info.description}
                </p>
              </div>
            </div>

            {/* Verses in this category */}
            <div class="space-y-2 ml-6">
              {relVerses.map(verse => (
                <a 
                  href={`/verse/${verse.verseId}`}
                  class={`block p-4 ${info.bg} border ${info.border} rounded-lg hover:shadow-md transition-all group`}
                >
                  <div class="space-y-2">
                    {/* Source and Verse Number */}
                    <div class="flex items-baseline gap-3">
                      <span class="text-xs font-semibold text-text-muted uppercase tracking-wide">
                        {extractSource(verse.reference)}
                      </span>
                      <span class={`text-lg font-bold ${info.color} group-hover:underline`}>
                        {extractVerseNum(verse.reference)}
                      </span>
                    </div>

                    {/* Full Reference */}
                    <p class="text-sm font-medium text-text-primary">
                      {verse.reference}
                    </p>

                    {/* Sanskrit Text Preview if available */}
                    {verse.text && (
                      <p class="sanskrit-small text-sm text-text-secondary italic">
                        "{verse.text.substring(0, 80)}{verse.text.length > 80 ? '...' : ''}"
                      </p>
                    )}

                    {/* Relationship Note */}
                    <div class={`flex items-start gap-2 pt-2 border-t ${info.border}`}>
                      <span class={`text-xs ${info.color} mt-0.5`}>â†’</span>
                      <p class="text-xs text-text-secondary leading-relaxed">
                        <strong class="text-text-primary">Connection:</strong> {verse.note}
                      </p>
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </div>
        );
      })}
    </div>

    {/* Helpful Note */}
    <div class="mt-6 pt-4 border-t border-border">
      <p class="text-xs text-text-muted italic text-center">
        ðŸ’¡ Study these verses together to gain a deeper understanding of the teaching
      </p>
    </div>
  </section>
)}
