---
interface WordItem {
  word: string;
  transliteration: string;
  meaning: string;
  grammar: string;
  root?: string;
}

interface Props {
  devanagari: string;
  size?: 'large' | 'small';
  center?: boolean;
  words?: WordItem[];
  interactive?: boolean;
}

const { devanagari, size = 'large', center = true, words = [], interactive = false } = Astro.props;
const sizeClass = size === 'large' ? 'sanskrit' : 'sanskrit-small';
const alignClass = center ? 'text-center' : '';
const uniqueId = `verse-${Math.random().toString(36).substr(2, 9)}`;
---

<div class={`${sizeClass} ${alignClass} bg-bg-sanskrit p-6 rounded-lg ${interactive ? 'interactive-verse' : ''}`}>
  {interactive && words.length > 0 ? (
    <div class="verse-container">
      <!-- Normal verse view (default) -->
      <div id={`${uniqueId}-normal`} class="normal-verse cursor-pointer" data-target={`${uniqueId}-words`}>
        {devanagari}
      </div>
      
      <!-- Word-by-word view (hidden by default) -->
      <div id={`${uniqueId}-words`} class="word-view hidden cursor-pointer" data-target={`${uniqueId}-normal`}>
        {words.map((wordData, index) => (
          <span class="word-tooltip-wrapper inline-block">
            <span class="clickable-word cursor-help hover:text-accent-saffron transition-colors border-b-2 border-transparent hover:border-accent-saffron px-1">
              {wordData.word}
              <span class="tooltip-content">
                <span class="tooltip-transliteration">{wordData.transliteration}</span>
                <span class="tooltip-meaning">{wordData.meaning}</span>
                <span class="tooltip-grammar">{wordData.grammar}</span>
                {wordData.root && <span class="tooltip-root">Root: {wordData.root}</span>}
              </span>
            </span>
            {index < words.length - 1 && ' '}
          </span>
        ))}
      </div>
    </div>
  ) : (
    devanagari
  )}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Handle clicks on normal verses to toggle to word view
    document.querySelectorAll('.normal-verse').forEach(element => {
      element.addEventListener('click', (e) => {
        const target = (e.currentTarget as HTMLElement).dataset.target;
        if (target) {
          const wordView = document.getElementById(target);
          if (wordView) {
            (e.currentTarget as HTMLElement).classList.add('hidden');
            wordView.classList.remove('hidden');
          }
        }
      });
    });

    // Handle clicks on word view to toggle back to normal
    document.querySelectorAll('.word-view').forEach(element => {
      element.addEventListener('click', (e) => {
        const target = (element as HTMLElement).dataset.target;
        if (target) {
          const normalView = document.getElementById(target);
          if (normalView) {
            element.classList.add('hidden');
            normalView.classList.remove('hidden');
          }
        }
      });
    });
  });
</script>

<style>
  .normal-verse {
    position: relative;
  }

  .normal-verse::after {
    content: '✨ Click to see word meanings';
    display: block;
    font-size: 0.75rem;
    font-family: var(--font-family-body);
    color: var(--color-text-muted);
    margin-top: 0.75rem;
    font-weight: normal;
  }

  .word-view::after {
    content: '← Click to return to full verse';
    display: block;
    font-size: 0.75rem;
    font-family: var(--font-family-body);
    color: var(--color-text-muted);
    margin-top: 0.75rem;
    font-weight: normal;
    text-align: center;
  }

  .normal-verse:hover {
    opacity: 0.9;
  }

  .word-view {
    cursor: default;
  }

  .word-tooltip-wrapper {
    position: relative;
  }

  .clickable-word {
    position: relative;
  }

  .tooltip-content {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-8px);
    background-color: var(--color-text-primary);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    white-space: nowrap;
    z-index: 100;
    font-size: 0.875rem;
    font-family: var(--font-family-body);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    pointer-events: none;
    transition: opacity 0.2s ease, transform 0.2s ease;
    min-width: 200px;
    max-width: 300px;
    white-space: normal;
    text-align: left;
  }

  .tooltip-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: var(--color-text-primary);
  }

  .clickable-word:hover .tooltip-content {
    visibility: visible;
    opacity: 1;
    transform: translateX(-50%) translateY(-4px);
  }

  .tooltip-transliteration {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    font-style: italic;
    color: #fbbf24;
  }

  .tooltip-meaning {
    display: block;
    margin-bottom: 6px;
    line-height: 1.4;
  }

  .tooltip-grammar {
    display: block;
    font-size: 0.75rem;
    opacity: 0.8;
    margin-bottom: 4px;
  }

  .tooltip-root {
    display: block;
    font-size: 0.75rem;
    font-style: italic;
    opacity: 0.7;
  }

  .interactive-verse {
    cursor: pointer;
  }

  .hidden {
    display: none;
  }
</style>
